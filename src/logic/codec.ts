// src/logic/codec.ts
import questionsData from '../data/questions.json';

// 1. ä½ çš„å®Œæ•´ Emoji å­—å…¸ (è¯·æŠŠæ–‡ä»¶é‡Œçš„å®Œæ•´æ•°ç»„è´´åœ¨è¿™é‡Œ)
const EMOJI_MAP: string[] = [
        'ğŸ†˜', 'ğŸ†™', 'ğŸ†š', 'ğŸˆ', 'ğŸˆ‚', 'ğŸˆš', 'ğŸˆ¯', 'ğŸˆ²', 'ğŸˆ³', 'ğŸˆ´', 'ğŸˆµ',
        'ğŸˆ¶', 'ğŸˆ·', 'ğŸˆ¸', 'ğŸˆ¹', 'ğŸˆº', 'ğŸ‰', 'ğŸ‰‘', 'ğŸŒ€', 'ğŸŒ', 'ğŸŒ‚',
        'ğŸŒƒ', 'ğŸŒ„', 'ğŸŒ…', 'ğŸŒ†', 'ğŸŒ‡', 'ğŸŒˆ', 'ğŸŒ‰', 'ğŸŒŠ', 'ğŸŒ‹', 'ğŸŒŒ',
        'ğŸŒ', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ‘', 'ğŸŒ’', 'ğŸŒ“', 'ğŸŒ”', 'ğŸŒ•', 'ğŸŒ–',
        'ğŸŒ—', 'ğŸŒ˜', 'ğŸŒ™', 'ğŸŒš', 'ğŸŒ›', 'ğŸŒœ', 'ğŸŒ', 'ğŸŒ', 'ğŸŒŸ', 'ğŸŒ ',
        'ğŸŒ¡', 'ğŸŒ¤', 'ğŸŒ¥', 'ğŸŒ¦', 'ğŸŒ§', 'ğŸŒ¨', 'ğŸŒ©', 'ğŸŒª', 'ğŸŒ«', 'ğŸŒ¬',
        'ğŸŒ­', 'ğŸŒ®', 'ğŸŒ¯', 'ğŸŒ°', 'ğŸŒ±', 'ğŸŒ²', 'ğŸŒ³', 'ğŸŒ´', 'ğŸŒµ', 'ğŸŒ¶',
        'ğŸŒ·', 'ğŸŒ¸', 'ğŸŒ¹', 'ğŸŒº', 'ğŸŒ»', 'ğŸŒ¼', 'ğŸŒ½', 'ğŸŒ¾', 'ğŸŒ¿', 'ğŸ€',
        'ğŸ', 'ğŸ‚', 'ğŸƒ', 'ğŸ„', 'ğŸ…', 'ğŸ†', 'ğŸ‡', 'ğŸˆ', 'ğŸ‰', 'ğŸŠ',
        'ğŸ‹', 'ğŸŒ', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ‘', 'ğŸ’', 'ğŸ“', 'ğŸ”',
        'ğŸ•', 'ğŸ–', 'ğŸ—', 'ğŸ˜', 'ğŸ™', 'ğŸš', 'ğŸ›', 'ğŸœ', 'ğŸ', 'ğŸ',
        'ğŸŸ', 'ğŸ ', 'ğŸ¡', 'ğŸ¢', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¦', 'ğŸ§', 'ğŸ¨',
        'ğŸ©', 'ğŸª', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ®', 'ğŸ¯', 'ğŸ°', 'ğŸ±', 'ğŸ²',
        'ğŸ³', 'ğŸ´', 'ğŸµ', 'ğŸ¶', 'ğŸ·', 'ğŸ¸', 'ğŸ¹', 'ğŸº', 'ğŸ»', 'ğŸ¼',
        'ğŸ½', 'ğŸ¾', 'ğŸ¿', 'ğŸ€', 'ğŸ', 'ğŸ‚', 'ğŸƒ', 'ğŸ„', 'ğŸ…', 'ğŸ†',
        'ğŸ‡', 'ğŸˆ', 'ğŸ‰', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ',
        'ğŸ‘', 'ğŸ’', 'ğŸ“', 'ğŸ–', 'ğŸ—', 'ğŸ™', 'ğŸš', 'ğŸ›', 'ğŸ', 'ğŸŸ',
        'ğŸ ', 'ğŸ¡', 'ğŸ¢', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¦', 'ğŸ§', 'ğŸ¨', 'ğŸ©',
        'ğŸª', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ®', 'ğŸ¯', 'ğŸ°', 'ğŸ±', 'ğŸ²', 'ğŸ³',
        'ğŸ´', 'ğŸµ', 'ğŸ¶', 'ğŸ·', 'ğŸ¸', 'ğŸ¹', 'ğŸº', 'ğŸ»', 'ğŸ¼', 'ğŸ½',
        'ğŸ¾', 'ğŸ¿', 'ğŸ€', 'ğŸ', 'ğŸ‚', 'ğŸƒ', 'ğŸ„', 'ğŸ…', 'ğŸ†', 'ğŸ‡',
        'ğŸˆ', 'ğŸ‰', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ‘',
        'ğŸ’', 'ğŸ“', 'ğŸ”', 'ğŸ•', 'ğŸ–', 'ğŸ—', 'ğŸ˜', 'ğŸ™', 'ğŸš', 'ğŸ›',
        'ğŸœ', 'ğŸ', 'ğŸ', 'ğŸŸ', 'ğŸ ', 'ğŸ¡', 'ğŸ¢', 'ğŸ£', 'ğŸ¤', 'ğŸ¥',
        'ğŸ¦', 'ğŸ§', 'ğŸ¨', 'ğŸ©', 'ğŸª', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ®', 'ğŸ¯',
        'ğŸ°', 'ğŸ³', 'ğŸ´', 'ğŸµ', 'ğŸ·', 'ğŸ¸', 'ğŸ¹', 'ğŸº', 'ğŸ€', 'ğŸ',
        'ğŸ‚', 'ğŸƒ', 'ğŸ„', 'ğŸ…', 'ğŸ†', 'ğŸ‡', 'ğŸˆ', 'ğŸ‰', 'ğŸŠ', 'ğŸ‹',
        'ğŸŒ', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ‘', 'ğŸ’', 'ğŸ“', 'ğŸ”', 'ğŸ•',
        'ğŸ–', 'ğŸ—', 'ğŸ˜', 'ğŸ™', 'ğŸš', 'ğŸ›', 'ğŸœ', 'ğŸ', 'ğŸ', 'ğŸŸ',
        'ğŸ ', 'ğŸ¡', 'ğŸ¢', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¦', 'ğŸ§', 'ğŸ¨', 'ğŸ©',
        'ğŸª', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ®', 'ğŸ¯', 'ğŸ°', 'ğŸ±', 'ğŸ²', 'ğŸ³',
        'ğŸ´', 'ğŸµ', 'ğŸ¶', 'ğŸ·', 'ğŸ¸', 'ğŸ¹', 'ğŸº', 'ğŸ»', 'ğŸ¼', 'ğŸ½',
        'ğŸ¾', 'ğŸ¿', 'ğŸ‘€', 'ğŸ‘', 'ğŸ‘‚', 'ğŸ‘ƒ', 'ğŸ‘„', 'ğŸ‘…', 'ğŸ‘†', 'ğŸ‘‡',
        'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘Š', 'ğŸ‘‹', 'ğŸ‘Œ', 'ğŸ‘', 'ğŸ‘', 'ğŸ‘', 'ğŸ‘', 'ğŸ‘‘',
        'ğŸ‘’', 'ğŸ‘“', 'ğŸ‘”', 'ğŸ‘•', 'ğŸ‘–', 'ğŸ‘—', 'ğŸ‘˜', 'ğŸ‘™', 'ğŸ‘š', 'ğŸ‘›',
        'ğŸ‘œ', 'ğŸ‘', 'ğŸ‘', 'ğŸ‘Ÿ', 'ğŸ‘ ', 'ğŸ‘¡', 'ğŸ‘¢', 'ğŸ‘£', 'ğŸ‘¤', 'ğŸ‘¥',
        'ğŸ‘¦', 'ğŸ‘§', 'ğŸ‘¨', 'ğŸ‘©', 'ğŸ‘ª', 'ğŸ‘«', 'ğŸ‘¬', 'ğŸ‘­', 'ğŸ‘®', 'ğŸ‘¯',
        'ğŸ‘°', 'ğŸ‘±', 'ğŸ‘²', 'ğŸ‘³', 'ğŸ‘´', 'ğŸ‘µ', 'ğŸ‘¶', 'ğŸ‘·', 'ğŸ‘¸', 'ğŸ‘¹',
        'ğŸ‘º', 'ğŸ‘»', 'ğŸ‘¼', 'ğŸ‘½', 'ğŸ‘¾', 'ğŸ‘¿', 'ğŸ’€', 'ğŸ’', 'ğŸ’‚', 'ğŸ’ƒ',
        'ğŸ’„', 'ğŸ’…', 'ğŸ’†', 'ğŸ’‡', 'ğŸ’ˆ', 'ğŸ’‰', 'ğŸ’Š', 'ğŸ’‹', 'ğŸ’Œ', 'ğŸ’',
        'ğŸ’', 'ğŸ’', 'ğŸ’', 'ğŸ’‘', 'ğŸ’’', 'ğŸ’“', 'ğŸ’”', 'ğŸ’•', 'ğŸ’–', 'ğŸ’—',
        'ğŸ’˜', 'ğŸ’™', 'ğŸ’š', 'ğŸ’›', 'ğŸ’œ', 'ğŸ’', 'ğŸ’', 'ğŸ’Ÿ', 'ğŸ’ ', 'ğŸ’¡',
        'ğŸ’¢', 'ğŸ’£', 'ğŸ’¤', 'ğŸ’¥', 'ğŸ’¦', 'ğŸ’§', 'ğŸ’¨', 'ğŸ’©', 'ğŸ’ª', 'ğŸ’«',
        'ğŸ’¬', 'ğŸ’­', 'ğŸ’®', 'ğŸ’¯', 'ğŸ’°', 'ğŸ’±', 'ğŸ’²', 'ğŸ’³', 'ğŸ’´', 'ğŸ’µ',
        'ğŸ’¶', 'ğŸ’·', 'ğŸ’¸', 'ğŸ’¹', 'ğŸ’º', 'ğŸ’»', 'ğŸ’¼', 'ğŸ’½', 'ğŸ’¾', 'ğŸ’¿',
        'ğŸ“€', 'ğŸ“', 'ğŸ“‚', 'ğŸ“ƒ', 'ğŸ“„', 'ğŸ“…', 'ğŸ“†', 'ğŸ“‡', 'ğŸ“ˆ', 'ğŸ“‰',
        'ğŸ“Š', 'ğŸ“‹', 'ğŸ“Œ', 'ğŸ“', 'ğŸ“', 'ğŸ“', 'ğŸ“', 'ğŸ“‘', 'ğŸ“’', 'ğŸ““',
        'ğŸ“”', 'ğŸ“•', 'ğŸ“–', 'ğŸ“—', 'ğŸ“˜', 'ğŸ“™', 'ğŸ“š', 'ğŸ“›', 'ğŸ“œ', 'ğŸ“',
        'ğŸ“', 'ğŸ“Ÿ', 'ğŸ“ ', 'ğŸ“¡', 'ğŸ“¢', 'ğŸ“£', 'ğŸ“¤', 'ğŸ“¥', 'ğŸ“¦', 'ğŸ“§',
        'ğŸ“¨', 'ğŸ“©', 'ğŸ“ª', 'ğŸ“«', 'ğŸ“¬', 'ğŸ“­', 'ğŸ“®', 'ğŸ“¯', 'ğŸ“°', 'ğŸ“±',
        'ğŸ“²', 'ğŸ“³', 'ğŸ“´', 'ğŸ“µ', 'ğŸ“¶', 'ğŸ“·', 'ğŸ“¸', 'ğŸ“¹', 'ğŸ“º', 'ğŸ“»',
        'ğŸ“¼', 'ğŸ“½', 'ğŸ“¿', 'ğŸ”€', 'ğŸ”', 'ğŸ”‚', 'ğŸ”ƒ', 'ğŸ”„', 'ğŸ”…', 'ğŸ”†',
        'ğŸ”‡', 'ğŸ”ˆ', 'ğŸ”‰', 'ğŸ”Š', 'ğŸ”‹', 'ğŸ”Œ', 'ğŸ”', 'ğŸ”', 'ğŸ”', 'ğŸ”',
        'ğŸ”‘', 'ğŸ”’', 'ğŸ”“', 'ğŸ””', 'ğŸ”•', 'ğŸ”–', 'ğŸ”—', 'ğŸ”˜', 'ğŸ”™', 'ğŸ”š',
        'ğŸ”›', 'ğŸ”œ', 'ğŸ”', 'ğŸ”', 'ğŸ”Ÿ', 'ğŸ” ', 'ğŸ”¡', 'ğŸ”¢', 'ğŸ”£', 'ğŸ”¤',
        'ğŸ”¥', 'ğŸ”¦', 'ğŸ”§', 'ğŸ”¨', 'ğŸ”©', 'ğŸ”ª', 'ğŸ”«', 'ğŸ”¬', 'ğŸ”­', 'ğŸ”®',
        'ğŸ”¯', 'ğŸ”°', 'ğŸ”±', 'ğŸ”²', 'ğŸ”³', 'ğŸ”´', 'ğŸ”µ', 'ğŸ”¶', 'ğŸ”·', 'ğŸ”¸',
        'ğŸ”¹', 'ğŸ”º', 'ğŸ”»', 'ğŸ”¼', 'ğŸ”½', 'ğŸ•‰', 'ğŸ•Š', 'ğŸ•‹', 'ğŸ•Œ', 'ğŸ•',
        'ğŸ•', 'ğŸ•', 'ğŸ•‘', 'ğŸ•’', 'ğŸ•“', 'ğŸ•”', 'ğŸ••', 'ğŸ•–', 'ğŸ•—', 'ğŸ•˜',
        'ğŸ•™', 'ğŸ•š', 'ğŸ•›', 'ğŸ•œ', 'ğŸ•', 'ğŸ•', 'ğŸ•Ÿ', 'ğŸ• ', 'ğŸ•¡', 'ğŸ•¢',
        'ğŸ•£', 'ğŸ•¤', 'ğŸ•¥', 'ğŸ•¦', 'ğŸ•§', 'ğŸ•¯', 'ğŸ•°', 'ğŸ•³', 'ğŸ•´', 'ğŸ•µ',
        'ğŸ•¶', 'ğŸ•·', 'ğŸ•¸', 'ğŸ•¹', 'ğŸ•º', 'ğŸ–‡', 'ğŸ–Š', 'ğŸ–‹', 'ğŸ–Œ', 'ğŸ–',
        'ğŸ–', 'ğŸ–•', 'ğŸ––', 'ğŸ–¤', 'ğŸ–¥', 'ğŸ–¨', 'ğŸ–±', 'ğŸ–²', 'ğŸ–¼', 'ğŸ—‚',
        'ğŸ—ƒ', 'ğŸ—„', 'ğŸ—‘', 'ğŸ—’', 'ğŸ—“', 'ğŸ—œ', 'ğŸ—', 'ğŸ—', 'ğŸ—¡', 'ğŸ—£',
        'ğŸ—¨', 'ğŸ—¯', 'ğŸ—³', 'ğŸ—º', 'ğŸ—»', 'ğŸ—¼', 'ğŸ—½', 'ğŸ—¾', 'ğŸ—¿', 'ğŸ˜€',
        'ğŸ˜', 'ğŸ˜‚', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜…', 'ğŸ˜†', 'ğŸ˜‡', 'ğŸ˜ˆ', 'ğŸ˜‰', 'ğŸ˜Š',
        'ğŸ˜‹', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ˜', 'ğŸ˜', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜’', 'ğŸ˜“', 'ğŸ˜”',
        'ğŸ˜•', 'ğŸ˜–', 'ğŸ˜—', 'ğŸ˜˜', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ˜', 'ğŸ˜',
        'ğŸ˜Ÿ', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ˜¢', 'ğŸ˜£', 'ğŸ˜¤', 'ğŸ˜¥', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨',
        'ğŸ˜©', 'ğŸ˜ª', 'ğŸ˜«', 'ğŸ˜¬', 'ğŸ˜­', 'ğŸ˜®', 'ğŸ˜¯', 'ğŸ˜°', 'ğŸ˜±', 'ğŸ˜²',
        'ğŸ˜³', 'ğŸ˜´', 'ğŸ˜µ', 'ğŸ˜¶', 'ğŸ˜·', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜º', 'ğŸ˜»', 'ğŸ˜¼',
        'ğŸ˜½', 'ğŸ˜¾', 'ğŸ˜¿', 'ğŸ™€', 'ğŸ™', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ™„', 'ğŸ™…', 'ğŸ™†',
        'ğŸ™‡', 'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š', 'ğŸ™‹', 'ğŸ™Œ', 'ğŸ™', 'ğŸ™', 'ğŸ™', 'ğŸš€',
        'ğŸš', 'ğŸš‚', 'ğŸšƒ', 'ğŸš„', 'ğŸš…', 'ğŸš†', 'ğŸš‡', 'ğŸšˆ', 'ğŸš‰', 'ğŸšŠ',
        'ğŸš‹', 'ğŸšŒ', 'ğŸš', 'ğŸš', 'ğŸš', 'ğŸš', 'ğŸš‘', 'ğŸš’', 'ğŸš“', 'ğŸš”',
        'ğŸš•', 'ğŸš–', 'ğŸš—', 'ğŸš˜', 'ğŸš™', 'ğŸšš', 'ğŸš›', 'ğŸšœ', 'ğŸš', 'ğŸš',
        'ğŸšŸ', 'ğŸš ', 'ğŸš¡', 'ğŸš¢', 'ğŸš£', 'ğŸš¤', 'ğŸš¥', 'ğŸš¦', 'ğŸš§', 'ğŸš¨',
        'ğŸš©', 'ğŸšª', 'ğŸš«', 'ğŸš¬', 'ğŸš­', 'ğŸš®', 'ğŸš¯', 'ğŸš°', 'ğŸš±', 'ğŸš²',
        'ğŸš³', 'ğŸš´', 'ğŸšµ', 'ğŸš¶', 'ğŸš·', 'ğŸš¸', 'ğŸš¹', 'ğŸšº', 'ğŸš»', 'ğŸš¼',
        'ğŸš½', 'ğŸš¾', 'ğŸš¿', 'ğŸ›€', 'ğŸ›', 'ğŸ›‚', 'ğŸ›ƒ', 'ğŸ›„', 'ğŸ›…', 'ğŸ›‹',
        'ğŸ›Œ', 'ğŸ›', 'ğŸ›', 'ğŸ›', 'ğŸ›', 'ğŸ›‘', 'ğŸ›’', 'ğŸ› ', 'ğŸ›¡', 'ğŸ›¢',
        'ğŸ›£', 'ğŸ›¤', 'ğŸ›¥', 'ğŸ›©', 'ğŸ›«', 'ğŸ›¬', 'ğŸ›°', 'ğŸ›³', 'ğŸ›´', 'ğŸ›µ',
        'ğŸ›¶', 'ğŸ›·', 'ğŸ›¸', 'ğŸ›¹', 'ğŸ¤', 'ğŸ¤‘', 'ğŸ¤’', 'ğŸ¤“', 'ğŸ¤”', 'ğŸ¤•',
        'ğŸ¤–', 'ğŸ¤—', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ¤š', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ¤', 'ğŸ¤', 'ğŸ¤Ÿ',
        'ğŸ¤ ', 'ğŸ¤¡', 'ğŸ¤¢', 'ğŸ¤£', 'ğŸ¤¤', 'ğŸ¤¥', 'ğŸ¤¦', 'ğŸ¤§', 'ğŸ¤¨', 'ğŸ¤©',
        'ğŸ¤ª', 'ğŸ¤«', 'ğŸ¤¬', 'ğŸ¤­', 'ğŸ¤®', 'ğŸ¤¯', 'ğŸ¤°', 'ğŸ¤±', 'ğŸ¤²', 'ğŸ¤³',
        'ğŸ¤´', 'ğŸ¤µ', 'ğŸ¤¶', 'ğŸ¤·', 'ğŸ¤¸', 'ğŸ¤¹', 'ğŸ¤º', 'ğŸ¤¼', 'ğŸ¤½', 'ğŸ¤¾',
        'ğŸ¥€', 'ğŸ¥', 'ğŸ¥‚', 'ğŸ¥ƒ', 'ğŸ¥„', 'ğŸ¥…', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ¥Š',
        'ğŸ¥‹', 'ğŸ¥Œ', 'ğŸ¥', 'ğŸ¥', 'ğŸ¥', 'ğŸ¥', 'ğŸ¥‘', 'ğŸ¥’', 'ğŸ¥“', 'ğŸ¥”',
        'ğŸ¥•', 'ğŸ¥–', 'ğŸ¥—', 'ğŸ¥˜', 'ğŸ¥™', 'ğŸ¥š', 'ğŸ¥›', 'ğŸ¥œ', 'ğŸ¥', 'ğŸ¥',
        'ğŸ¥Ÿ', 'ğŸ¥ ', 'ğŸ¥¡', 'ğŸ¥¢', 'ğŸ¥£', 'ğŸ¥¤', 'ğŸ¥¥', 'ğŸ¥¦', 'ğŸ¥§', 'ğŸ¥¨',
        'ğŸ¥©', 'ğŸ¥ª', 'ğŸ¥«', 'ğŸ¥¬', 'ğŸ¥­', 'ğŸ¥®', 'ğŸ¥¯', 'ğŸ¥°', 'ğŸ¥³', 'ğŸ¥´',
        'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ¥º', 'ğŸ¥¼', 'ğŸ¥½', 'ğŸ¥¾', 'ğŸ¥¿', 'ğŸ¦€', 'ğŸ¦', 'ğŸ¦‚',
        'ğŸ¦ƒ', 'ğŸ¦„', 'ğŸ¦…', 'ğŸ¦†', 'ğŸ¦‡', 'ğŸ¦ˆ', 'ğŸ¦‰', 'ğŸ¦Š', 'ğŸ¦‹', 'ğŸ¦Œ',
        'ğŸ¦', 'ğŸ¦', 'ğŸ¦', 'ğŸ¦', 'ğŸ¦‘', 'ğŸ¦’', 'ğŸ¦“', 'ğŸ¦”', 'ğŸ¦•', 'ğŸ¦–',
        'ğŸ¦—', 'ğŸ¦˜', 'ğŸ¦™', 'ğŸ¦š', 'ğŸ¦›', 'ğŸ¦œ', 'ğŸ¦', 'ğŸ¦', 'ğŸ¦Ÿ', 'ğŸ¦ ',
        'ğŸ¦¡', 'ğŸ¦¢', 'ğŸ¦°', 'ğŸ¦±', 'ğŸ¦²', 'ğŸ¦³', 'ğŸ¦´', 'ğŸ¦µ', 'ğŸ¦¶', 'ğŸ¦·',
        'ğŸ¦¸', 'ğŸ¦¹', 'ğŸ§€', 'ğŸ§', 'ğŸ§‚', 'ğŸ§', 'ğŸ§‘', 'ğŸ§’', 'ğŸ§“', 'ğŸ§”',
        'ğŸ§•', 'ğŸ§–', 'ğŸ§—', 'ğŸ§˜', 'ğŸ§™', 'ğŸ§š', 'ğŸ§›', 'ğŸ§œ', 'ğŸ§', 'ğŸ§',
        'ğŸ§Ÿ', 'ğŸ§ ', 'ğŸ§¡', 'ğŸ§¢', 'ğŸ§£', 'ğŸ§¤', 'ğŸ§¥', 'ğŸ§¦', 'ğŸ§§', 'ğŸ§¨',
        'ğŸ§©', 'ğŸ§ª', 'ğŸ§«', 'ğŸ§¬', 'ğŸ§­', 'ğŸ§®', 'ğŸ§¯', 'ğŸ§°', 'ğŸ§±', 'ğŸ§²',
        'ğŸ§³', 'ğŸ§´', 'ğŸ§µ', 'ğŸ§¶', 'ğŸ§·', 'ğŸ§¸', 'ğŸ§¹', 'ğŸ§º', 'ğŸ§»', 'ğŸ§¼',
        'ğŸ§½', 'ğŸ§¾', 'ğŸ§¿', 'ğŸ†—'
];

// å»ºç«‹åå‘ç´¢å¼•
const EMOJI_TO_INDEX = new Map<string, number>();
EMOJI_MAP.forEach((emoji, index) => {
  EMOJI_TO_INDEX.set(emoji, index);
});

// --- 2. é¢„è®¾å¤´åƒåˆ—è¡¨ ---
export const AVATARS = [
  'ğŸŒ','ğŸ¦Š','ğŸ°','ğŸ±','ğŸ¶',
  'ğŸ¦','ğŸ¯','ğŸ¼','ğŸ»','ğŸ¦„',
  'ğŸ³','ğŸ¦ˆ','ğŸ£','ğŸ¦‹','ğŸŒ¹',
  'ğŸŒ»','ğŸŒ¼','ğŸŒ±','ğŸŒ³','ğŸ'
];
const AVATAR_SET = new Set(AVATARS); 

// --- 3. å‹ç¼©ç®—æ³•é…ç½® ---
const BLOCK_SIZE = 5;      
const BITS_PER_VAL = 3;    

// è¾…åŠ©ï¼šæ•°å­—è½¬æŒ‡å®šé•¿åº¦äºŒè¿›åˆ¶å­—ç¬¦ä¸²
function toBits(num: number, length: number = BITS_PER_VAL): string {
  return num.toString(2).padStart(length, '0');
}

/**
 * âœ… æ–°å¢è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—æ ¡éªŒå’Œ (Checksum)
 * ç®—æ³•ï¼šå°†æ‰€æœ‰ 10-bit æ•°æ®å—çš„å€¼æ±‚å’Œï¼Œå¯¹å­—å…¸é•¿åº¦å–æ¨¡ï¼Œå¾—åˆ°æ ¡éªŒä½çš„ Emoji ç´¢å¼•
 */
function calculateChecksum(indices: number[]): number {
  if (indices.length === 0) return 0;
  const sum = indices.reduce((acc, val) => acc + val, 0);
  return sum % EMOJI_MAP.length;
}

/**
 * ç¼–ç ï¼šå¤´åƒ + å‹ç¼©åçš„ Emoji æ•°æ®æµ + æ ¡éªŒä½ Emoji
 */
export function encode(answers: Record<string, number[]>, avatar: string = 'ğŸŒ'): string {
  
  // ç¬¬ä¸€æ­¥ï¼šæ•°æ®æ‰å¹³åŒ–
  const flatData: number[] = [];
  questionsData.modules.forEach(m => {
    m.questions.forEach(q => {
      const userStates = answers[q.id] || [];
      q.options.forEach((_, optIndex) => {
        let state = userStates[optIndex] || 0;
        // ğŸ”„ ä¿®æ”¹ï¼šä¸ºäº†æ”¯æŒ 6 ç§çŠ¶æ€ (0-5)ï¼Œè¿™é‡Œå°†ä¸Šé™è°ƒæ•´ä¸º 5
        // 3 bit å¯ä»¥æ”¯æŒåˆ° 7 (0-7)ï¼Œæ‰€ä»¥è¿™é‡Œçš„ä¿®æ”¹æ˜¯å®‰å…¨çš„
        if (state > 5) state = 0; 
        flatData.push(state);
      });
    });
  });

  // å¯»æ‰¾â€œæœ‰æ•ˆæ•°æ®çš„è¾¹ç•Œâ€ (æˆªæ–­ä¼˜åŒ–)
  let lastActiveBlockIndex = -1;
  for (let i = 0; i < flatData.length; i += BLOCK_SIZE) {
    const chunk = flatData.slice(i, i + BLOCK_SIZE);
    if (chunk.some(v => v !== 0)) {
      lastActiveBlockIndex = i;
    }
  }

  // å¦‚æœå…¨æ˜¯0ï¼Œç›´æ¥è¿”å›å¤´åƒ (è¿™é‡Œæˆ‘ä»¬ä¸åŠ æ ¡éªŒä½ï¼Œè§†ä¸ºç©ºæ•°æ®çš„ç‰¹æ®Šæƒ…å†µ)
  if (lastActiveBlockIndex === -1) return avatar;

  // ç¬¬äºŒæ­¥ï¼šåˆ†å—ä½å›¾å‹ç¼©
  let bitStream = "";
  for (let i = 0; i <= lastActiveBlockIndex; i += BLOCK_SIZE) {
    const chunk = flatData.slice(i, i + BLOCK_SIZE);
    const isAllZero = chunk.every(val => val === 0);

    if (isAllZero) {
      bitStream += "0";
    } else {
      bitStream += "1";
      chunk.forEach(val => {
        bitStream += toBits(val);
      });
    }
  }

  // ç¬¬ä¸‰æ­¥ï¼šBitStream è½¬ Emoji + è®¡ç®—æ ¡éªŒä½
  // è¡¥é½ 10 bit
  const remainder = bitStream.length % 10;
  if (remainder !== 0) {
    bitStream += "0".repeat(10 - remainder);
  }

  let result = "";
  const indices: number[] = []; // ç”¨äºå­˜å‚¨è½¬æ¢åçš„ç´¢å¼•ï¼Œä»¥ä¾¿è®¡ç®—æ ¡éªŒå’Œ

  for (let i = 0; i < bitStream.length; i += 10) {
    const chunkStr = bitStream.substring(i, i + 10);
    const val = parseInt(chunkStr, 2);
    
    // è®°å½•ç´¢å¼•ç”¨äºæ ¡éªŒ
    indices.push(val);
    
    result += (EMOJI_MAP[val] !== undefined) ? EMOJI_MAP[val] : EMOJI_MAP[0];
  }

  // âœ… æ–°å¢ï¼šè®¡ç®—å¹¶è¿½åŠ æ ¡éªŒä½
  const checksumIndex = calculateChecksum(indices);
  const checksumEmoji = EMOJI_MAP[checksumIndex];

  return avatar + result + checksumEmoji;
}

/**
 * è§£ç ï¼šæå–å¤´åƒ + æ ¡éªŒæ•°æ® + è¿˜åŸç­”æ¡ˆå­—å…¸
 */
export function decode(code: string): { answers: Record<string, number[]>, avatar: string } {
  // 1. æ¸…æ´— (ä¿æŒä¸å˜)
  const cleanCode = code.replace(/[\s\n\r\uFE0F]/g, '');
  if (!cleanCode) throw new Error("æ— æ•ˆçš„ä»£ç ï¼šå†…å®¹ä¸ºç©º");

  const chars = Array.from(cleanCode);
  
  // 2. æå–å¤´åƒ (ä¿æŒä¸å˜)
  let avatar = 'ğŸŒ'; 
  let dataAndChecksumChars: string[] = [];

  const firstChar = chars[0];
  if (firstChar && AVATAR_SET.has(firstChar)) {
    avatar = firstChar;
    dataAndChecksumChars = chars.slice(1); 
  } else {
    dataAndChecksumChars = chars;
  }

  if (dataAndChecksumChars.length < 1) {
      return { answers: {}, avatar };
  }

  // --- åˆ†ç¦» æ•°æ®ä½“ å’Œ æ½œåœ¨çš„æ ¡éªŒä½ ---
  const providedChecksumEmoji = dataAndChecksumChars[dataAndChecksumChars.length - 1]; // å¯èƒ½æ˜¯æ ¡éªŒä½ï¼Œä¹Ÿå¯èƒ½æ˜¯æ—§æ•°æ®çš„æœ€åä¸€ä½
  const dataEmojis = dataAndChecksumChars.slice(0, -1); // å¯èƒ½æ˜¯å‰©ä½™æ•°æ®

  // 3. è½¬æ¢ç´¢å¼• (ä¿æŒä¸å˜)
  const indices: number[] = [];
  
  // å…ˆè§£æå‰é¢çš„éƒ¨åˆ†
  for (const char of dataEmojis) {
    const val = EMOJI_TO_INDEX.get(char);
    if (val === undefined) throw new Error(`è§£æå¤±è´¥ï¼šåŒ…å«æ— æ³•è¯†åˆ«çš„å­—ç¬¦ "${char}"`);
    indices.push(val);
  }

  // è·å–æœ€åä¸€ä½çš„æ•°å€¼
  if (!providedChecksumEmoji) throw new Error("ä»£ç æ ¼å¼ä¸å®Œæ•´");
  const lastCharVal = EMOJI_TO_INDEX.get(providedChecksumEmoji);
  if (lastCharVal === undefined) throw new Error(`è§£æå¤±è´¥ï¼šåŒ…å«æ— æ³•è¯†åˆ«çš„å­—ç¬¦ "${providedChecksumEmoji}"`);


  // --- âœ… æ ¸å¿ƒä¿®æ”¹ï¼šå…¼å®¹æ—§ä»£ç çš„æ ¡éªŒé€»è¾‘ ---
  
  // è®¡ç®—å‰é¢æ•°æ®çš„æ ¡éªŒå€¼
  const calculatedChecksumIndex = calculateChecksum(indices);
  
  // æ¯”å¯¹ï¼šè®¡ç®—å‡ºçš„å€¼ vs æœ€åä¸€ä½çš„å€¼
  if (calculatedChecksumIndex === lastCharVal) {
    // A. æ ¡éªŒæˆåŠŸï¼
    // è¯´æ˜è¿™æ˜¯æ–°ç‰ˆä»£ç  (V2)ï¼Œindices å°±æ˜¯å®Œæ•´çš„æ•°æ®ï¼ŒlastCharVal æ˜¯æ ¡éªŒä½ï¼ˆå·²æ¶ˆè€—ï¼‰
    // ä»€ä¹ˆéƒ½ä¸ç”¨åšï¼Œç»§ç»­å¾€ä¸‹èµ°
  } else {
    // B. æ ¡éªŒå¤±è´¥ï¼
    // å¯èƒ½æ€§ 1ï¼šä»£ç è¢«ç¯¡æ”¹äº†ã€‚
    // å¯èƒ½æ€§ 2ï¼šè¿™æ˜¯ä¸€ä¸ªæ—§ç‰ˆä»£ç  (V1)ï¼Œæ—§ä»£ç æ²¡æœ‰æ ¡éªŒä½ï¼Œæ‰€ä»¥æœ€åä¸€ä½å…¶å®æ˜¯æ•°æ®ï¼Œä¸æ˜¯æ ¡éªŒä½ã€‚
    
    console.warn("æ ¡éªŒä½ä¸åŒ¹é…ï¼Œå°è¯•ä½œä¸ºæ—§ç‰ˆä»£ç è§£æ...");

    // å…¼å®¹ç­–ç•¥ï¼šå°†æœ€åä¸€ä½å½“ä½œæ™®é€šæ•°æ®ï¼Œæ”¾å›æ•°ç»„ä¸­
    indices.push(lastCharVal);
    
    // æ³¨æ„ï¼šè¿™æ ·åšçš„ä»£ä»·æ˜¯ï¼Œå¦‚æœçœŸçš„æ˜¯â€œè¢«ç¯¡æ”¹çš„æ–°ä»£ç â€ï¼Œä¹Ÿä¼šè¢«å¼ºè¡Œè§£æï¼Œ
    // ä½†è§£æå‡ºæ¥çš„æ•°æ®æœ«å°¾ä¼šæœ‰ä¹±ç ã€‚ä¸ºäº†å…¼å®¹æ—§ä»£ç ï¼Œè¿™ä¸ªé£é™©æ˜¯å¿…é¡»æ‰¿æ‹…çš„ã€‚
  }


  // 4. é‡å»º BitStream (é€»è¾‘å¾®è°ƒ)
  // æ­¤æ—¶ indices å·²ç»åŒ…å«äº†æ‰€æœ‰éœ€è¦è¿˜åŸçš„æ•°æ®ï¼ˆå¦‚æœæ˜¯æ–°ä»£ç ï¼Œå°±ä¸å«æ ¡éªŒä½ï¼›å¦‚æœæ˜¯æ—§ä»£ç ï¼Œå°±åŒ…å«æœ€åä¸€ä½ï¼‰
  let bitStream = "";
  for (const val of indices) {
    bitStream += toBits(val, 10);
  }

  // 3. è§£å‹ BitStream åˆ°æ‰å¹³æ•°ç»„ (é€»è¾‘ä¿æŒä¸å˜)
  const flatData: number[] = [];
  let ptr = 0;
  
  let totalOptionsCount = 0;
  questionsData.modules.forEach(m => m.questions.forEach(q => totalOptionsCount += q.options.length));

  while (ptr < bitStream.length && flatData.length < totalOptionsCount) {
    const header = bitStream[ptr];
    ptr++; 

    const remainingNeeded = totalOptionsCount - flatData.length;
    const currentBlockSize = Math.min(BLOCK_SIZE, remainingNeeded);

    if (header === '0') {
      for (let k = 0; k < currentBlockSize; k++) flatData.push(0);
    } else {
      for (let k = 0; k < currentBlockSize; k++) {
        if (ptr + 3 <= bitStream.length) {
          const valStr = bitStream.substring(ptr, ptr + 3);
          const val = parseInt(valStr, 2);
          flatData.push(val);
          ptr += 3;
        } else {
          flatData.push(0);
        }
      }
    }
  }

  // è‡ªåŠ¨è¡¥é½å‰©ä½™çš„ 0
  while (flatData.length < totalOptionsCount) {
    flatData.push(0);
  }

  // 4. æ‰å¹³æ•°ç»„ æ˜ å°„å› å¯¹è±¡ç»“æ„ (é€»è¾‘ä¿æŒä¸å˜)
  const result: Record<string, number[]> = {};
  let dataPtr = 0;

  questionsData.modules.forEach(m => {
    m.questions.forEach(q => {
      const qStates: number[] = [];
      let hasData = false;

      q.options.forEach(() => {
        const val = flatData[dataPtr] || 0;
        qStates.push(val);
        if (val > 0) hasData = true;
        dataPtr++;
      });

      if (hasData) {
        result[q.id] = qStates;
      }
    });
  });

  return { answers: result, avatar };
}